<form class="grid-container" [formGroup]="auditBuilderForm" novalidate (ngSubmit)="ui.formSubmit($event)" (change)='ui.inputChange($event)'>
  <mat-card>
      <mat-card-content>
        <lib-audit-global
          [title]='auditBuilderForm.controls.title'
          [timeout]='auditBuilderForm.controls.timeout'
          [device]='auditBuilderForm.controls.device'
        />
        <mat-accordion multi>
          <mat-expansion-panel *ngFor='let stepFormGroup of auditBuilderForm.controls.steps.controls; let i = index'>
            <mat-expansion-panel-header>
              <mat-panel-title>{{ stepFormGroup.controls.type.value || 'Audit Step Required!' }}</mat-panel-title>
            </mat-expansion-panel-header>
            <div class='row' *ngFor='let controlKey of getStepControlsKeys(stepFormGroup)'>
              <div class='col' *ngIf='isValueControl(getControl(stepFormGroup, controlKey))'>
                <mat-form-field>
                  <mat-label>{{controlKey}}</mat-label>
                  <input
                    matInput
                    type='text'
                    required
                    [pattern]='STEP_TYPES_VALIDATOR_PATTERN'
                    placeholder='Audit Step'
                    aria-label='Audit Step'
                    [formControl]='getControl(stepFormGroup, controlKey)'
                    [matAutocomplete]='auto'
                  >
                  <mat-autocomplete #auto="matAutocomplete">
                    <mat-option
                      *ngFor="let option of filteredOptions(STEP_TYPES, stepFormGroup.controls.type.value)"
                      [value]="option"
                    >{{option}}</mat-option>
                  </mat-autocomplete>
                  <mat-error *ngIf="stepFormGroup.controls.type.hasError('required')">
                    Step type is <strong>required</strong>
                  </mat-error>
                  <mat-error *ngIf="stepFormGroup.controls.type.hasError('pattern')">
                    Step type is <strong>not supported</strong>
                  </mat-error>
                </mat-form-field>
                <button mat-icon-button style='top: 40px' class="more-button" (click)='$event.preventDefault()' [matMenuTriggerFor]="menu" aria-label="Toggle menu">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #menu="matMenu" xPosition="before">
                  <button mat-menu-item (click)='addStep(i)'>Add Step Before</button>
                  <button mat-menu-item (click)='addStep(i + 1)'>Add Step After</button>
                  <button mat-menu-item (click)='auditBuilderForm.controls.steps.removeAt(i)'>Remove Step</button>
                </mat-menu>
              </div>
              <div class='col' *ngIf='!isValueControl(getControl(stepFormGroup, controlKey))'>
                <p>{{controlKey}}</p>
                <mat-form-field *ngFor='let subControlKey of getStepControlsKeys(getControl(stepFormGroup, controlKey))'>
                  <mat-label>{{subControlKey}}</mat-label>
                  <input
                    matInput
                    type='text'
                    required
                    [pattern]='STEP_TYPES_VALIDATOR_PATTERN'
                    placeholder='Audit Step'
                    aria-label='Audit Step'
                    [formControl]='getControl(getControl(stepFormGroup, controlKey), subControlKey)'
                  >
                  <mat-error *ngIf="stepFormGroup.controls.type.hasError('required')">
                    Step type is <strong>required</strong>
                  </mat-error>
                  <mat-error *ngIf="stepFormGroup.controls.type.hasError('pattern')">
                    Step type is <strong>not supported</strong>
                  </mat-error>
                </mat-form-field>
                <button mat-icon-button style='top: 40px' class="more-button" (click)='$event.preventDefault()' [matMenuTriggerFor]="menu" aria-label="Toggle menu">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #menu="matMenu" xPosition="before">
                  <button mat-menu-item (click)='addStep(i)'>Add Step Before</button>
                  <button mat-menu-item (click)='addStep(i + 1)'>Add Step After</button>
                  <button mat-menu-item (click)='auditBuilderForm.controls.steps.removeAt(i)'>Remove Step</button>
                </mat-menu>
              </div>
            </div>
          </mat-expansion-panel>
        </mat-accordion>
      </mat-card-content>
    </mat-card>
</form>
